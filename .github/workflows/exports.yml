name: KiCAD Exports

on:
  workflow_dispatch:
  push:
  pull_request:

permissions:
  contents: read

concurrency: ci-${{ github.ref }}

jobs:
  export:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Generate artifact name ğŸ“‹
      id: generate-name
      run: |
        echo "::set-output name=artifact::${{ github.event.repository.name }}_${{ github.ref_name }}_$(git log -1 --format="%as").zip"

    - name: Checkout ğŸ›ï¸
      uses: actions/checkout@v3
    
    # https://github.com/INTI-CMNB/KiBot/#usage-of-github-actions
    # https://github.com/nerdyscout/KiCAD-CICD-Template
    - name: Generate KiCAD exports ğŸ”§
      uses: INTI-CMNB/KiBot@v2_k6
      with:
        config: kibot.yaml
        dir: output
        schema: "PCB/easylight.kicad_sch"
        board: "PCB/easylight.kicad_pcb"
        
    - name: Upload results ğŸ“¦
      if: ${{ always() }}  # I want any output I can get
      uses: actions/upload-artifact@v3
      with:
        if-no-files-found: error
        name: ${{ steps.generate-name.outputs.artifact }}
        path: output/
        
    - name: Release ğŸš€
      if: startsWith(github.ref, 'refs/tags/')        
      uses: softprops/action-gh-release@v1
      with:
        files: output/*